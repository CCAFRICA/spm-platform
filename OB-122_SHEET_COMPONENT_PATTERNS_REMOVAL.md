# OB-122: SHEET_COMPONENT_PATTERNS Removal — Engine input_bindings as Primary Path

## READ FIRST
- `CC_STANDING_ARCHITECTURE_RULES.md` — ALL sections (9 principles, anti-patterns, operational rules)
- `SCHEMA_REFERENCE.md` — calculation_results, rule_sets tables
- This prompt in its entirety before writing any code

## AUTONOMY DIRECTIVE
NEVER ask yes/no. NEVER say "shall I". Just act. Complete all phases, all proof gates, commit, push, PR.

---

## PROBLEM STATEMENT

`SHEET_COMPONENT_PATTERNS` is a hardcoded lookup table that maps domain-specific pattern strings to component names and sheet identifiers. It was the original mechanism for connecting data files to plan components. Decision 64's Convergence Layer (OB-120) replaced this with runtime semantic matching that generates `input_bindings` and `MetricDerivationRules` — domain-agnostic, Korean Test compliant.

Despite being deprecated (HF-077 added deprecation notice), SHEET_COMPONENT_PATTERNS still has **15 references** in the codebase. OB-120's convergence service uses it as a "fast path" before falling back to token overlap matching. This is **CC Failure Pattern 20**: the legacy pattern table is being enshrined as primary path instead of being replaced.

**Architecture trace Layer 5 (Code Integrity)** reports SHEET_COMPONENT_PATTERNS as one of 3 remaining Korean Test failures.

---

## CONTEXT: WHAT REPLACED SHEET_COMPONENT_PATTERNS

The Decision 64 pipeline provides three mechanisms that replace SHEET_COMPONENT_PATTERNS entirely:

### 1. input_bindings (rule_sets JSONB column)
Generated by convergence. Maps each plan component to its data source via semantic data_type matching. The engine reads `input_bindings` to know which committed_data to query for each component.

### 2. MetricDerivationRules (generated by convergence)
Rules that transform raw committed_data into the metrics each component needs. Include filters (e.g., filter by product_type) discovered from the data at runtime. Stored in input_bindings.

### 3. Convergence semantic matching
Matches plan requirements (what the plan needs) to data capabilities (what committed_data provides) using semantic data_type overlap and keyword scoring. Zero hardcoded patterns.

**These three mechanisms are already working in production.** MBC's $3,256,677.72 is calculated entirely through input_bindings + MetricDerivationRules. SHEET_COMPONENT_PATTERNS is legacy scaffolding.

---

## DIAGNOSTIC PHASE (Do this FIRST, commit findings)

### Step 1: Find ALL SHEET_COMPONENT_PATTERNS references

```bash
grep -rn "SHEET_COMPONENT_PATTERNS" src/ --include="*.ts" --include="*.tsx"
```

Record every file:line. Categorize each reference:

| Category | Action |
|----------|--------|
| **Definition** (where the pattern table is defined) | Delete entirely |
| **Import** (importing the table) | Remove import |
| **Fast path** (convergence uses it before semantic matching) | Remove fast path, rely on semantic matching only |
| **Fallback** (used when input_bindings are empty) | Replace with convergence gap reporting |
| **Type reference** (TypeScript type for the pattern table) | Delete type |
| **Test/diagnostic** (architecture trace checks for it) | Update to verify it's GONE (0 references) |

### Step 2: Verify input_bindings are populated for all active MBC plans

```sql
SELECT name, 
       input_bindings IS NOT NULL AND input_bindings::text != '{}' as has_bindings
FROM rule_sets 
WHERE tenant_id = (SELECT id FROM tenants WHERE slug = 'mexican-bank-co')
  AND status = 'active';
```

All 4 plans should have input_bindings. If any don't, convergence needs to run for those plans before we can remove SHEET_COMPONENT_PATTERNS.

### Step 3: Trace the calculation path

For the "Calculate All 4 Plans" flow (POST /api/calculation/run):
1. Where does the engine currently read SHEET_COMPONENT_PATTERNS?
2. Where does the engine currently read input_bindings?
3. What happens if SHEET_COMPONENT_PATTERNS is removed but input_bindings exist?
4. What happens if SHEET_COMPONENT_PATTERNS is removed and input_bindings are EMPTY?

Case 4 is the safety question. For tenants without convergence (Óptica Luminar, Pipeline Test Co), removing SHEET_COMPONENT_PATTERNS could break their calculations. We need a graceful degradation path.

### Step 4: Check other tenants

```sql
SELECT t.slug, rs.name,
       rs.input_bindings IS NOT NULL AND rs.input_bindings::text != '{}' as has_bindings
FROM rule_sets rs
JOIN tenants t ON rs.tenant_id = t.id
WHERE rs.status = 'active'
ORDER BY t.slug, rs.name;
```

Any tenant with `has_bindings = false` will lose calculation ability if SHEET_COMPONENT_PATTERNS is the only path. Document which tenants are affected.

---

## ARCHITECTURE DECISION (Commit before implementation)

```
ARCHITECTURE DECISION RECORD
============================
Problem: Remove SHEET_COMPONENT_PATTERNS while preserving calculation ability for all tenants.

Option A: Hard removal — delete all references, calculations fail for tenants without input_bindings
  - Scale test: Yes
  - AI-first: Yes (no hardcoded patterns)
  - Korean Test: PASS
  - Risk: Breaks Óptica Luminar, Pipeline Test Co, any tenant without convergence

Option B: Replace with input_bindings as PRIMARY, empty fallback returns zero with warning
  - Scale test: Yes
  - AI-first: Yes
  - Korean Test: PASS
  - Risk: Some plans produce $0 until convergence runs — but with clear gap reporting

Option C: Replace with input_bindings as PRIMARY, keep SHEET_COMPONENT_PATTERNS as Tier 3 deterministic fallback (Decision 64 spec says this)
  - Scale test: Yes
  - AI-first: Partially — patterns still exist as last resort
  - Korean Test: FAIL — patterns contain domain vocabulary
  - Risk: Patterns never get removed, Pattern 20 continues

RECOMMENDED: Option B
  - input_bindings is the ONLY resolution path
  - If input_bindings are empty, the engine returns $0 for that component with a convergence gap warning
  - This forces tenants through the Decision 64 pipeline to get results
  - Clean removal, Korean Test compliant, no legacy scaffolding
  
REJECTED: Option C — perpetuates Pattern 20. The "fallback" becomes the permanent path for lazy migrations.
REJECTED: Option A — too aggressive. Need graceful $0 + warning, not hard failure.
```

---

## IMPLEMENTATION PHASES

### Phase 1: Delete SHEET_COMPONENT_PATTERNS definition and type
- Remove the pattern table definition (likely in a constants or patterns file)
- Remove the TypeScript type/interface
- Remove all imports of both
- Commit with `grep` proof showing 0 remaining definition/type references

### Phase 2: Remove convergence fast path
- In `convergence-service.ts`, remove any code path that checks SHEET_COMPONENT_PATTERNS before semantic matching
- The convergence service should ONLY use: semantic data_type matching → keyword scoring → MetricDerivationRule generation
- Korean Test verification: grep `convergence-service.ts` for any remaining domain vocabulary

### Phase 3: Engine — input_bindings as sole resolution path
- In `run-calculation.ts` and `route.ts`: when resolving which committed_data feeds a component, read ONLY from `input_bindings`
- If `input_bindings` is empty/null for a rule_set: 
  - Log a warning: "No input_bindings for plan [name]. Run convergence to generate bindings."
  - Return $0 payout for all entities in this plan
  - Include in convergence gap report
- Remove any `findMatchingSheet()` calls that use SHEET_COMPONENT_PATTERNS

### Phase 4: Update architecture trace
- Architecture trace probe Layer 5 (SHEET_COMPONENT_PATTERNS Usage) should now verify: **0 references**
- Update the probe to PASS when count = 0 (currently it reports the count as a Korean Test failure)
- This converts the 13/16 → 14/16 Korean Test pass rate

### Phase 5: Verification — MBC recalculation
- Run "Calculate All 4 Plans" for MBC on localhost
- Verify grand total ≈ $3,256,677.72
- Verify 320 rows, zero duplicates
- This proves MBC works through input_bindings alone

### Phase 6: Verification — Pipeline Test Co
- Run calculation for Pipeline Test Co on localhost
- If input_bindings exist: verify $1,253,832 ground truth
- If input_bindings don't exist: verify graceful $0 with warning (not a crash)
- Document Pipeline Test Co status in completion report

### Phase 7: CC-UAT Dual Traces (Decision 67 — MANDATORY)

**Architecture Trace:**
- Run against tenant with most committed_data
- Expected improvement: SHEET_COMPONENT_PATTERNS probe → 0 references → Korean Test PASS
- Target: 14/16 Korean Test (up from 13/16)
- 0 DOMAIN_LEAK must be maintained

**Calculation Trace:**
- Run against entity with most committed_data rows (Luis, entity 1005)
- Verify: metric resolution path uses input_bindings, NOT pattern matching
- Verify: no "SHEET_COMPONENT_PATTERNS" appears anywhere in the trace output

### Phase 8: Build + PR

---

## PROOF GATES

| Gate | Description | Verification |
|------|-------------|-------------|
| PG-01 | 0 SHEET_COMPONENT_PATTERNS references in src/ | `grep -rn "SHEET_COMPONENT_PATTERNS" src/` returns nothing |
| PG-02 | 0 findMatchingSheet references (or function deleted) | `grep -rn "findMatchingSheet" src/` returns nothing |
| PG-03 | `npm run build` clean | Zero TypeScript errors |
| PG-04 | MBC calculation succeeds | All 4 plans, no errors |
| PG-05 | MBC grand total ≈ $3,256,677.72 | Within 1% of verified baseline |
| PG-06 | MBC 320 rows, zero duplicates | SQL verification |
| PG-07 | Pipeline Test Co graceful handling | Either correct total OR $0 with warning (no crash) |
| PG-08 | Architecture trace: 0 DOMAIN_LEAK | Maintained from HF-077 |
| PG-09 | Architecture trace: 14/16 Korean Test | Up from 13/16 (SHEET_COMPONENT_PATTERNS probe now PASS) |
| PG-10 | Architecture trace: SHEET_COMPONENT_PATTERNS probe = 0 | Layer 5 shows zero references |
| PG-11 | Calculation trace: no pattern matching in resolution path | Luis's metric resolution uses input_bindings exclusively |
| PG-12 | Convergence gap report for plans without input_bindings | Clear warning message, not silent $0 |

---

## CC FAILURE PATTERNS TO AVOID

- **Pattern 19 (Domain vocabulary leak):** Removing SHEET_COMPONENT_PATTERNS must not introduce NEW domain vocabulary. The replacement path (input_bindings) must remain Korean Test compliant.
- **Pattern 20 (SHEET_COMPONENT_PATTERNS dependency):** This is the pattern we're eliminating. Do NOT create a "temporary" replacement lookup table. input_bindings is the path.
- **Pattern 21 (Dual code path):** HF-079 consolidated to single API route. Ensure the SHEET_COMPONENT_PATTERNS removal applies to that single path, not a ghost second path.
- **AP-17 (Two code paths for same feature):** After removal, there should be ONE resolution mechanism: input_bindings → MetricDerivationRules → engine execution. No fallback to patterns.

---

## WHAT SUCCESS LOOKS LIKE

After OB-122:
- `grep -rn "SHEET_COMPONENT_PATTERNS" src/` → 0 results
- MBC calculates correctly through input_bindings only
- Architecture trace shows 14/16 Korean Test (up from 13/16)
- The engine is fully domain-agnostic in its data resolution path
- Any tenant without convergence-generated input_bindings gets $0 + clear warning, not a crash
- Decision 64's original promise is fulfilled: the hardcoded pattern table is gone

---

## GIT PROTOCOL

1. All work on `dev` branch
2. Commit diagnostic findings (Phase 0)
3. Commit each implementation phase separately
4. `git push origin dev` after each commit
5. Kill dev server → `rm -rf .next` → `npm run build` → `npm run dev` → confirm localhost:3000
6. Run both CC-UAT traces, include output in completion report
7. `gh pr create --base main --head dev --title "OB-122: Remove SHEET_COMPONENT_PATTERNS — input_bindings as sole resolution path" --body "Removes 15 SHEET_COMPONENT_PATTERNS references. Engine now resolves data exclusively through convergence-generated input_bindings. Korean Test 13/16 → 14/16. MBC $3,256,677.72 maintained. All proof gates pass."`
