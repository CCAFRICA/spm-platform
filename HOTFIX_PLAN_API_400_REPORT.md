# Hotfix Report: Plan Interpretation API 400 Error

## Problem

After OB-22 enhanced the plan interpretation AI prompt, the Anthropic API began returning 400 errors, causing fallback to heuristic detection which:
- Detected only 4 generic components instead of 7 real ones
- Extracted ZERO tier/payout values
- Resulted in $0 payouts for all employees

## Root Cause Analysis

**Identified Cause: Invalid JSON examples + insufficient token limits**

The OB-22 enhancement added JSON examples containing `Infinity` values:
```javascript
{ "min": 150, "max": Infinity, "label": "150% o mas" }
```

Issues with this:
1. `Infinity` is a JavaScript value, NOT valid JSON
2. When the AI sees this example and tries to return similar JSON, JSON.parse() fails
3. The response token limit (8000) may have been insufficient for the large tier/matrix response expected

## Fix Applied

### 1. Replace Infinity with 999999

**Before:**
```javascript
{ "min": 150, "max": Infinity, "label": "150% o mas" }
{ "min": 110, "max": Infinity, "payout": 500, "label": ">=110%" }
```

**After:**
```javascript
{ "min": 150, "max": 999999, "label": "150% o mas" }
{ "min": 110, "max": 999999, "payout": 500, "label": ">=110%" }
```

This ensures the AI returns valid JSON that can be parsed.

### 2. Increase max_tokens for plan interpretation

**Before:**
- ai-service.ts: `maxTokens: 8000`
- anthropic-adapter.ts default: `maxTokens || 4000`

**After:**
- ai-service.ts: `maxTokens: 16384`
- anthropic-adapter.ts default: `maxTokens || 8192`

The enhanced prompt asks for complete tier/matrix data with every cell value. For 7 components including two 5x6 matrices, the JSON response can be substantial.

---

## Files Changed

| File | Changes |
|------|---------|
| `src/lib/ai/providers/anthropic-adapter.ts` | Replace Infinity with 999999, increase default max_tokens |
| `src/lib/ai/ai-service.ts` | Increase interpretPlan maxTokens to 16384 |

---

## Proof Gate Status

| # | Criterion | Status |
|---|-----------|--------|
| 1 | Root cause identified | PASS - Invalid JSON (Infinity) + token limits |
| 2 | Anthropic API call succeeds | PENDING BROWSER TEST |
| 3 | Plan interpretation returns 6-7 components | PENDING BROWSER TEST |
| 4 | At least one component has non-empty tier/matrix data | PENDING BROWSER TEST |
| 5 | Plan saved includes tier/matrix values | PENDING BROWSER TEST |
| 6 | No diagnostic logging remains | PASS |
| 7 | Build succeeds | PASS |
| 8 | localhost:3000 responds 200 | PASS |
| 9 | Total Compensation reported | PENDING END-TO-END TEST |

---

## Commit

| Hash | Description |
|------|-------------|
| `8a8be53` | Hotfix: Fix plan interpretation API 400 error |

---

## Verification Required

To verify the fix works:

1. Navigate to RetailCGMX > Plan Import
2. Upload RetailCorp_Plan1.pptx
3. Check console - should NOT see 400/500 errors
4. Verify 6-7 components detected (NOT 4 heuristic fallback)
5. Confirm tier/matrix values are populated in localStorage

---

*Generated by Hotfix: Plan Interpretation API 400 Error*
*Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>*
