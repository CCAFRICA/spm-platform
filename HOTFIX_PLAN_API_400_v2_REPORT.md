# Hotfix Report v2: Plan Interpretation API 400 Error - maxTokens Exceeded

## Problem

After Hotfix v1 increased maxTokens to 16384, the Anthropic API continued returning 400 errors because Claude Sonnet 4's maximum output token limit is 8192.

## Root Cause Analysis

**Identified Cause: maxTokens exceeded model limit**

Hotfix v1 changed:
```typescript
// ai-service.ts interpretPlan()
options: { responseFormat: 'json', maxTokens: 16384 }  // Exceeds Sonnet 4 limit!
```

Claude Sonnet 4 (`claude-sonnet-4-20250514`) has a maximum output token limit of **8192 tokens**. Requesting 16384 causes the API to reject the request with a 400 error.

## Fix Applied

### Lower maxTokens to Model Maximum

**Before (Hotfix v1):**
```typescript
// ai-service.ts line 209
options: { responseFormat: 'json', maxTokens: 16384 },
```

**After (Hotfix v2):**
```typescript
// ai-service.ts line 209
options: { responseFormat: 'json', maxTokens: 8192 },
```

This ensures the requested token limit stays within Claude Sonnet 4's capabilities.

---

## Files Changed

| File | Changes |
|------|---------|
| `src/lib/ai/ai-service.ts` | Lower maxTokens from 16384 to 8192 |

---

## Token Limits Reference

| Model | Max Output Tokens |
|-------|-------------------|
| Claude Sonnet 4 | 8192 |
| Claude Opus 4 | 32768 |
| Claude Haiku 3.5 | 8192 |

---

## Proof Gate Status

| # | Criterion | Status |
|---|-----------|--------|
| 1 | Root cause identified | PASS - maxTokens 16384 exceeds Sonnet 4 limit (8192) |
| 2 | maxTokens lowered to valid limit | PASS |
| 3 | Build succeeds | PASS |
| 4 | localhost:3000 responds 200 | PASS |
| 5 | Anthropic API call succeeds | PENDING BROWSER TEST |
| 6 | Plan interpretation returns 6-7 components | PENDING BROWSER TEST |
| 7 | At least one component has non-empty tier/matrix data | PENDING BROWSER TEST |
| 8 | Plan saved includes tier/matrix values | PENDING BROWSER TEST |
| 9 | Total Compensation > $0 | PENDING END-TO-END TEST |

---

## Commits

| Hash | Description |
|------|-------------|
| `8a8be53` | Hotfix v1: Fix plan interpretation API 400 error (Infinity + tokens) |
| `ec6f48a` | Hotfix v2: Lower maxTokens to 8192 (Sonnet 4 limit) |

---

## Verification Required

To verify the fix works:

1. Navigate to RetailCGMX > Plan Import
2. Upload RetailCorp_Plan1.pptx
3. Check console - should NOT see 400/500 errors
4. Verify 6-7 components detected (NOT 4 heuristic fallback)
5. Confirm tier/matrix values are populated in localStorage
6. Run calculation and verify Total Compensation > $0

---

## Combined Hotfix Summary

| Version | Issue | Fix |
|---------|-------|-----|
| v1 | `Infinity` not valid JSON | Replace with `999999` |
| v1 | Default maxTokens too low | Increase to 8192 |
| v2 | maxTokens 16384 exceeds model limit | Lower to 8192 |

---

*Generated by Hotfix v2: Plan Interpretation API 400 Error*
*Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>*
