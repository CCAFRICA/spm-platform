# OB-122: SHEET_COMPONENT_PATTERNS Removal — Completion Report

## Summary

Removed all 15 references to the hardcoded `SHEET_COMPONENT_PATTERNS` regex lookup table across 4 files. The calculation engine now resolves metrics exclusively through `input_bindings` (generated by the convergence service) and semantic type inference — no domain-specific patterns in foundational code.

## Changes

| File | What Changed |
|------|-------------|
| `metric-resolver.ts` | Deleted 10-entry pattern table (65 lines). Removed STRATEGY 2 from `findSheetForComponent()` — now AI context only. |
| `convergence-service.ts` | Removed import + Tier 1 fast path. Token-based semantic matching is sole resolution method. |
| `run-calculation.ts` | Removed import + pattern fallback from `findMatchingSheet()`. Replaced pattern-based store metric resolution with semantic type iteration across all store sheets. |
| `import/commit/route.ts` | Updated 2 comments that referenced SHEET_COMPONENT_PATTERNS. |

## Architecture Decision

**Option B — input_bindings as PRIMARY path** (chosen over Option A "aggressive removal" and Option C "perpetuate patterns").

- Tenants WITH input_bindings: convergence-generated derivation rules drive metric resolution
- Tenants WITHOUT input_bindings: `buildMetricsForComponent()` still works via direct name matching + semantic type resolution. Only pattern-based cross-language matching is lost.
- `findSheetForComponent()` retains STRATEGY 1 (AI context) — works for any language

## Verification

| # | Gate | Status | Detail |
|---|------|--------|--------|
| PG-01 | npm run build clean | PASS | Zero TypeScript errors |
| PG-02 | Zero SHEET_COMPONENT_PATTERNS refs in src/ | PASS | grep verified |
| PG-03 | MBC calculation succeeds (4 plans) | PASS | All OK |
| PG-04 | Grand total = $3,256,677.69 | PASS | Exact baseline match |
| PG-05 | Consumer Lending > $1M | PASS | $2,084,387.65 |
| PG-06 | Mortgage ~$1M | PASS | $1,046,890.04 |
| PG-07 | Insurance Referral > $0 | PASS | $125,400.00 |
| PG-08 | Deposit Growth > $0 | FAIL | $0 (pre-existing — not a regression) |
| PG-09 | Row count = 320 | PASS | 320 rows |
| PG-10 | Zero duplicate rows | PASS | 0 duplicates |
| PG-11 | Idempotent (re-run succeeds) | PASS | No constraint errors |
| PG-12 | PTC unaffected | PASS | 719 rows preserved |

**11/12 PASS.** PG-08 is pre-existing (Deposit Growth $0 existed before OB-122).

## Korean Test Impact

Before OB-122: SHEET_COMPONENT_PATTERNS contained domain vocabulary in 10 regex entries (Spanish optical terms, English banking terms). Any plan in Korean/Arabic/etc. would fail pattern matching.

After OB-122: Zero domain-specific patterns in foundational code. Resolution is purely structural (semantic type inference) + data-driven (input_bindings from convergence service).

## Lines of Code

- **Deleted:** 162 lines (pattern definitions, pattern-matching loops, fast paths)
- **Added:** 23 lines (semantic type iteration, updated comments)
- **Net:** -139 lines
