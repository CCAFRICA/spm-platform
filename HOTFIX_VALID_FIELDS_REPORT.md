# HOTFIX: Second Pass Valid Target Fields

## Executive Summary

Fixed the issue where AI correctly classified fields but they were skipped because the valid target fields list was missing core metric types (`amount`, `goal`, `attainment`, `quantity`, `storeRange`).

---

## Root Cause

### Location
**File:** `web/src/app/data/import/enhanced/page.tsx`
**Function:** `extractTargetFieldsFromPlan()` (lines 802-921)
**Variable:** `baseFields` array (lines 803-818)

### Problem

When a plan IS loaded and IS an additive lookup config:
- `baseFields` only included identifier fields: `employeeId`, `name`, `storeId`, `date`, `period`, `role`
- Core metric types were NOT included
- The function returned `[...baseFields, ...componentFields]` (line 921)
- Component fields are plan-specific (e.g., `venta_optica_attainment`) not generic semantic types

When NO plan or NOT additive lookup:
- Function returned baseFields PLUS generic metrics (lines 824-830)
- This path worked correctly

### Result

AI classified fields correctly:
```
"Monto Acotado" -> amount (95%)
"Monto_Recuperado_Meta" -> goal (95%)
"No Actual Club Protection" -> quantity (90%)
```

But validation at line 1057 checked: `targetFields.some(f => f.id === classification.semanticType)`
- `amount`, `goal`, `quantity` were NOT in `targetFields`
- Every classification was skipped

---

## Fix Applied

Added core metric types directly to `baseFields` so they are ALWAYS valid:

```typescript
const baseFields: TargetField[] = [
  // Identifier fields...
  { id: 'employeeId', ... },
  { id: 'name', ... },
  { id: 'storeId', ... },
  { id: 'date', ... },
  { id: 'period', ... },
  { id: 'role', ... },
  // HOTFIX: Core metric types - ALWAYS valid for AI classification
  { id: 'amount', label: 'Amount', labelEs: 'Monto', isRequired: false, category: 'amount' },
  { id: 'goal', label: 'Goal', labelEs: 'Meta', isRequired: false, category: 'metric' },
  { id: 'attainment', label: 'Attainment %', labelEs: '% Cumplimiento', isRequired: false, category: 'metric' },
  { id: 'quantity', label: 'Quantity', labelEs: 'Cantidad', isRequired: false, category: 'metric' },
  { id: 'storeRange', label: 'Store Range', labelEs: 'Rango Tienda', isRequired: false, category: 'identifier' },
];
```

Also simplified the no-plan fallback since baseFields now includes everything.

---

## Tier Summary

### BEFORE Fix
| Metric | Value |
|--------|-------|
| Tier 1 (auto) | 23 |
| Tier 2 (suggested) | 4 |
| Tier 3 (unresolved) | 13 |
| Second pass resolved | 0 (all skipped) |
| Validation warnings | 6 |

### AFTER Fix (Expected)
| Metric | Value |
|--------|-------|
| Tier 1 (auto) | 23 |
| Tier 2 (suggested) | 4+ (increased) |
| Tier 3 (unresolved) | <13 (decreased) |
| Second pass resolved | >0 |
| Validation warnings | <6 |

*Actual values require browser verification*

---

## Proof Gate Status

| # | Criterion | Status | Evidence |
|---|-----------|--------|----------|
| 1 | No "not a valid target field" skips for amount, goal, quantity | PASS | Fields now in baseFields |
| 2 | Second pass resolves > 0 fields | PENDING | Requires browser test |
| 3 | Tier 3 count AFTER second pass < 13 | PENDING | Requires browser test |
| 4 | Validation warning count < 6 | PENDING | Requires browser test |
| 5 | amount, goal, quantity appear as dropdown options | PASS | Included in baseFields |
| 6 | Build succeeds | PASS | npm run build completed |
| 7 | localhost:3000 responds 200 | PASS | Server running |

---

## Commit

| Hash | Description |
|------|-------------|
| `71e49cb` | Hotfix: Add amount/goal/quantity to valid target fields for second pass |

---

## Files Changed

**Modified:** `web/src/app/data/import/enhanced/page.tsx`
- Added 5 core metric types to `baseFields` array (lines 813-817)
- Simplified no-plan fallback to just return `baseFields`

---

## Complete Valid Target Fields (After Fix)

| ID | Label | Category |
|----|-------|----------|
| employeeId | Employee ID | identifier |
| name | Employee Name | identifier |
| storeId | Store ID | identifier |
| date | Date | date |
| period | Period | date |
| role | Role/Position | identifier |
| **amount** | Amount | amount |
| **goal** | Goal | metric |
| **attainment** | Attainment % | metric |
| **quantity** | Quantity | metric |
| **storeRange** | Store Range | identifier |

Plus any plan-specific component fields (e.g., `venta_optica_attainment`).

---

*Generated by HOTFIX: Valid Fields*
*Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>*
